{%- assign free_shipping_dollars = settings.free_shipping_limit | default: 60 -%}
{%- assign free_shipping_target = free_shipping_dollars | times: 100 -%}  <!-- Convert to cents -->

{%- assign current_amount = cart.total_price | default: 0 -%}

{%- assign progressRatio = current_amount | times: 1.0 | divided_by: free_shipping_target -%}
{%- assign clampedRatio = progressRatio | at_most: 1.0 -%}

{%- assign remaining_amount = free_shipping_target | minus: current_amount -%}
{%- if remaining_amount < 0 -%}
  {%- assign remaining_amount = 0 -%}
{%- endif -%}


<style>
<style>
  .bundle-progress-bar-wrapper {
    padding: 0 20px; /* ADD PADDING LEFT/RIGHT SAFELY */
  }

  @media (max-width: 480px) {
    .bundle-progress-bar-wrapper {
      padding: 0 28px; /* MORE SPACE ON TINY DEVICES */
    }
  }

  .bundle-progress-bar {
    margin: 20px 0;
    text-align: center;
    font-family: inherit;
  }

  .bundle-progress-bar__track {
    position: relative;
    height: 8px;
    background: #f0f0f0;
    border-radius: 999px;
    overflow: visible;
    width: 100%;
    max-width: 360px; /* reduced width so it doesn't hug edges */
    margin: 0 auto 16px; /* more breathing room */
  }

  .bundle-progress-bar__fill {
    background: #ff7e7e;
    height: 100%;
    transition: width 0.3s ease;
    border-radius: 999px;
    position: absolute;
    left: 0;
    top: 0;
    z-index: 1;
  }

  .bundle-progress-bar__dot {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 36px;
    height: 36px;
    background: #ff7e7e;
    border-radius: 50%;
    z-index: 2;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: left 0.3s ease;
    box-shadow: 0 0 6px rgba(0,0,0,0.15);
  }

  .bundle-progress-bar-text-wrapper {
    max-width: 100%;
    display: flex;
    justify-content: center;
    padding: 0 20px;
  }

  .bundle-progress-bar__text {
    font-size: 16px !important;
    font-style: italic;
    text-align: center;
    margin-top: 10px;
    line-height: 1.4;
  }

  .bundle-progress-divider {
    width: 100%;
    height: 1px;
    background: #fff;
    margin: 30px auto 0;
    max-width: 360px;
  }
</style>

</style>

<div class="bundle-progress-bar-wrapper">
  <div class="bundle-progress-bar">
    <div class="bundle-progress-bar__track">

      <div
        class="bundle-progress-bar__fill"
        style="width: {{ clampedRatio | times: 100 }}%;"
      ></div>

      <div
        class="bundle-progress-bar__dot"
        style="left: {{ clampedRatio | times: 100 }}%;"
      >
        <!-- Shipping truck icon -->
        <svg
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="#ffffff"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <rect x="1" y="3" width="15" height="13"></rect>
          <path d="M16 8h4l3 3v5h-7z"></path>
          <circle cx="5.5" cy="18" r="2"></circle>
          <circle cx="18.5" cy="18" r="2"></circle>
        </svg>
      </div>

    </div>

    {% if current_amount < free_shipping_target %}
      <div class="bundle-progress-bar-text-wrapper">
        <p class="bundle-progress-bar__text">
          You are <strong>{{ remaining_amount | money }}</strong> away from FREE shipping
        </p>
      </div>
    {% else %}
      <div class="bundle-progress-bar-text-wrapper">
        <p class="bundle-progress-bar__text">
          Free shipping unlocked! ðŸŽ‰
        </p>
      </div>
    {% endif %}
    
    <div class="bundle-progress-divider"></div>
  </div>
</div>

<script>
(function() {
  const freeShippingTarget = {{ free_shipping_target }};

  const updateProgressBar = () => {
    const wrapper = document.querySelector('.bundle-progress-bar-wrapper');
    const isCartEmpty = document.querySelector('[data-cart-empty]:not(.cart--hidden)');
    const fill = document.querySelector('.bundle-progress-bar__fill');
    const dot = document.querySelector('.bundle-progress-bar__dot');
    const text = document.querySelector('.bundle-progress-bar__text');

    if (wrapper) wrapper.style.display = isCartEmpty ? 'none' : 'block';
    if (isCartEmpty) return;

    fetch('/cart.js')
      .then(res => res.json())
      .then(cart => {
        const total = cart.total_price;
        const ratio = Math.min(total / freeShippingTarget, 1);
        const percent = ratio * 100;
        const remaining = Math.max(freeShippingTarget - total, 0);

        if (fill) fill.style.width = percent + '%';
        if (dot) dot.style.left = percent + '%';

        if (text) {
          if (remaining > 0) {
            text.innerHTML = `You are <strong>$${(remaining/100).toFixed(2)}</strong> away from FREE shipping`;
          } else {
            text.innerHTML = `Free shipping unlocked! `;
          }
        }
      });
  };

  setInterval(updateProgressBar, 400);
})();
</script>
